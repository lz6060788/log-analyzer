# 2025-08-04 更新日志

## 新增功能

### 自定义日志文件高亮规则
- 为Monaco Editor添加了自定义日志语言支持
- 实现了基础日志语言(`log`)和高级日志语言(`advanced-log`)两种模式
- 支持以下语法高亮规则：
  - 时间戳高亮（蓝色加粗）
  - UUID高亮（青色）
  - 日志级别高亮（ERROR红色、WARN橙色、INFO青色、DEBUG蓝色）
  - HTTP方法和状态码高亮
  - IP地址和端口号高亮
  - 文件路径高亮
  - 类名和方法名高亮
  - 异常类型高亮
  - JSON对象和数组高亮
  - 字符串和数字高亮

### 技术实现
- 创建了`logLanguage.ts`和`advancedLogLanguage.ts`定义语法规则
- 创建了`logLanguageManager.ts`统一管理语言配置
- 更新了`MonacoEditor.vue`组件以支持自定义语言
- 更新了`LogPasteView.vue`使用高级日志语言

### 文件变更
- 新增：`frontend/src/utils/logLanguage.ts` - 基础日志语言定义
- 新增：`frontend/src/utils/advancedLogLanguage.ts` - 高级日志语言定义  
- 新增：`frontend/src/utils/logLanguageManager.ts` - 语言配置管理器
- 修改：`frontend/src/components/common/MonacoEditor.vue` - 支持自定义语言
- 修改：`frontend/src/views/LogPasteView.vue` - 使用高级日志语言

## 技术方案选择说明

选择Monaco Editor的语言扩展机制而非其他方案的原因：

1. **原生支持**：Monaco Editor提供了完整的语言扩展API，性能更好
2. **实时高亮**：内置的语法分析器支持实时语法高亮
3. **可扩展性**：可以轻松添加更多规则和自定义主题
4. **主题兼容**：支持深色/浅色主题切换
5. **维护性**：使用官方API，长期维护更有保障

## Monaco内置minimap功能启用

### 功能需求
用户询问Monaco编辑器是否具有类似VS Code的内置minimap功能，以及自定义缩略图能否实现类似功能。

### 技术方案
采用**启用Monaco内置minimap**的方案，替代自定义缩略图实现，获得更好的性能和用户体验。

### 主要改进

#### 1. MonacoEditor组件增强
- **新增配置选项**: 添加`showMinimap`属性，支持动态控制minimap显示
- **启用内置minimap**: 配置完整的minimap功能，支持拖拽和悬停交互
- **优化配置参数**:
  ```typescript
  minimap: { 
    enabled: props.showMinimap !== false,
    size: 'proportional',
    side: 'right',
    showSlider: 'mouseover',
    maxColumn: 120
  }
  ```

#### 2. LogPoolView组件重构
- **移除自定义缩略图**: 删除复杂的自定义缩略图实现和`viewportOverlayStyle`计算
- **保留统计信息**: 右侧面板专注于显示行数统计和当前区间信息
- **优化布局**: 简化右侧面板，添加使用说明
- **代码简化**: 减少约50%的自定义代码

### 技术优势
- **原生性能**: 使用Monaco内置功能，性能最优
- **完整功能**: 支持拖拽定位、悬停滑块、键盘导航等完整功能
- **维护成本**: 代码量少，无需复杂的自定义实现
- **用户体验**: 与VS Code一致的交互体验

### 影响范围
- LogPoolView组件的缩略图显示方式
- 编辑器滚动交互体验
- 代码维护复杂度

### 文件修改
- `frontend/src/components/common/MonacoEditor.vue`: 启用内置minimap功能
- `frontend/src/views/LogPoolView.vue`: 重构布局，移除自定义缩略图

---

## MonacoEditor视口高度获取修复

### 问题描述
用户反馈 Monaco 编辑器的 `onDidScrollChange` 事件并没有传递 `viewportHeight` 变量，导致 `clientHeight` 计算错误，影响 LogPoolView 组件中的缩略图显示和行数统计功能。

### 修复内容
- **MonacoEditor.vue**: 修正视口高度获取方法
  - 使用 `editor.getLayoutInfo().height` 替代错误的 `e.viewportHeight` 属性访问
  - 确保传递给 LogPoolView 的 `clientHeight` 数据准确

### 技术实现
```typescript
// 修正前
clientHeight: e.viewportHeight  // 错误：该属性不存在

// 修正后
const viewportHeight = editor.getLayoutInfo().height;
clientHeight: viewportHeight  // 正确：使用官方API获取
```

### 影响范围
- LogPoolView 组件中的缩略图遮罩层显示
- 当前可见行数统计
- 滚动位置同步功能

### 文件修改
- `frontend/src/components/common/MonacoEditor.vue`: 修正视口高度获取方法

---

## LogPoolView日志合并时间排序功能

### 功能需求
用户需要将`totalLogList`变量（两个日志列表的集合）改为在合并时按时间排序，两个日志列表原先已经是按时间有序的，但两份日志数据的时间格式略有差异。

### 技术方案
采用**统一时间解析函数**的方案，处理两种不同的时间格式，然后按时间戳排序。

### 主要改进

#### 1. 时间格式处理
- **clientLogList时间格式**: `20250415 09:02:33.104`
- **operationLogList时间格式**: `20250415 09:18:39:730:830`
- **统一解析**: 创建`parseTimeToTimestamp`函数处理两种格式

#### 2. 排序逻辑实现
```typescript
const parseTimeToTimestamp = (timeStr: string): number => {
  // 处理 clientLogList 的时间格式: 20250415 09:02:33.104
  if (timeStr.includes(' ') && timeStr.includes('.')) {
    // 解析逻辑...
  }
  
  // 处理 operationLogList 的时间格式: 20250415 09:18:39:730:830
  if (timeStr.includes(':') && timeStr.split(':').length >= 4) {
    // 解析逻辑...
  }
  
  return 0 // 默认排在最后
}
```

#### 3. 合并排序优化
- **替换简单合并**: 将`[...clientLogList.value, ...operationLogList.value]`改为按时间排序
- **保持响应式**: 使用computed属性确保数据变化时自动重新排序
- **性能考虑**: 排序在computed中执行，避免重复计算

### 技术优势
- **格式兼容**: 支持两种不同的时间格式
- **容错处理**: 对不匹配的格式返回0，确保排序稳定性
- **性能优化**: 利用computed的缓存机制
- **代码清晰**: 分离时间解析逻辑，便于维护

### 影响范围
- LogPoolView组件中日志显示顺序
- 日志池中客户端日志和操作日志的混合显示
- 用户体验：日志按时间顺序显示，便于分析

### 文件修改
- `frontend/src/views/LogPoolView.vue`: 添加时间解析函数，修改totalLogList计算属性

---

## 日志合并性能优化与代码重构

### 功能需求
用户要求对日志合并功能进行两个改进：
1. 将`parseTimeToTimestamp`方法抽离到独立的时间操作函数文件中
2. 使用双指针方法优化排序性能，避免先合并再排序的低效操作

### 技术方案
采用**代码模块化**和**双指针合并算法**的方案，提升代码可维护性和性能。

### 主要改进

#### 1. 时间工具函数模块化
- **新建工具文件**: 创建`frontend/src/utils/timeUtils.ts`
- **函数抽离**: 将`parseTimeToTimestamp`方法独立为可复用工具函数
- **类型安全**: 添加完整的TypeScript类型注解和JSDoc注释
- **扩展功能**: 新增`mergeSortedArrays`双指针合并函数

#### 2. 双指针合并算法实现
```typescript
export const mergeSortedArrays = <T>(
  arr1: T[],
  arr2: T[],
  compareFn: (a: T, b: T) => number
): T[] => {
  const result: T[] = []
  let i = 0 // arr1 的指针
  let j = 0 // arr2 的指针
  
  // 双指针遍历，选择较小的元素
  while (i < arr1.length && j < arr2.length) {
    if (compareFn(arr1[i], arr2[j]) <= 0) {
      result.push(arr1[i])
      i++
    } else {
      result.push(arr2[j])
      j++
    }
  }
  
  // 处理剩余元素...
  return result
}
```

#### 3. LogPoolView组件优化
- **移除内联函数**: 删除组件内的`parseTimeToTimestamp`函数
- **导入工具函数**: 从`@/utils/timeUtils`导入所需函数
- **替换排序逻辑**: 使用`mergeSortedArrays`替代`sort`方法
- **性能提升**: 时间复杂度从O(n log n)降低到O(n)

### 技术优势
- **性能优化**: 双指针算法时间复杂度为O(n)，比排序算法O(n log n)更高效
- **代码复用**: 时间解析函数可在其他组件中复用
- **维护性**: 功能模块化，便于测试和维护
- **类型安全**: 完整的TypeScript类型支持

### 性能对比
- **优化前**: 先合并数组O(n) + 排序O(n log n) = O(n log n)
- **优化后**: 双指针合并O(n) = O(n)
- **性能提升**: 在大数据量时显著提升性能

### 影响范围
- 日志合并性能显著提升
- 代码结构更加模块化
- 时间处理功能可在其他组件复用

### 文件修改
- `frontend/src/utils/timeUtils.ts`: 新建时间工具函数文件
- `frontend/src/views/LogPoolView.vue`: 重构日志合并逻辑，使用双指针算法

---

## 命令式日志解析弹窗组件

### 功能需求
用户需要封装一个命令式的组件，调用后打开一个全屏的el-dialog弹窗，内部包含LogPasteView组件，其中logText由调用时传入，底部不需要操作按钮。

### 技术方案
采用**命令式组件设计模式**，通过动态创建Vue应用实例的方式实现弹窗组件，提供简洁的API调用接口。

### 主要改进

#### 1. LogPasteDialog组件
- **全屏弹窗**: 使用el-dialog的fullscreen属性实现全屏显示
- **属性传递**: 支持通过props接收logText参数
- **方法暴露**: 提供open和close方法供外部调用
- **样式优化**: 自定义弹窗样式，确保全屏显示效果

#### 2. 命令式服务工具
- **动态创建**: 使用createApp和h函数动态创建组件实例
- **单例管理**: 确保同时只有一个弹窗实例存在
- **资源清理**: 自动处理组件卸载和DOM清理
- **API设计**: 提供简洁的openLogPasteDialog和closeLogPasteDialog方法

#### 3. LogPasteView组件增强
- **属性支持**: 添加logText属性，支持外部传入日志内容
- **向后兼容**: 保持原有的内部状态管理逻辑

### 技术优势
- **命令式调用**: 无需在模板中声明组件，直接通过函数调用
- **全屏体验**: 提供沉浸式的日志解析界面
- **资源管理**: 自动处理组件生命周期和内存清理
- **类型安全**: 完整的TypeScript类型支持

### 使用方式
```typescript
// 导入工具函数
import { openLogPasteDialog, closeLogPasteDialog } from '@/utils/logPasteDialog';

// 打开弹窗
openLogPasteDialog('要解析的日志内容');

// 关闭弹窗
closeLogPasteDialog();
```

### 影响范围
- 新增命令式弹窗组件
- LogPasteView组件支持外部属性传入
- 提供便捷的日志解析调用方式

### 文件修改
- `frontend/src/components/common/LogPasteDialog.vue`: 新建全屏弹窗组件
- `frontend/src/utils/logPasteDialog.ts`: 新建命令式服务工具
- `frontend/src/views/LogPasteView.vue`: 添加logText属性支持
- `frontend/src/components/common/LogPasteDialogExample.vue`: 新建使用示例组件 

## LogPoolView集成日志解析弹窗功能

### 需求
- 在LogPoolView组件的Monaco编辑器中支持文本选择
- 通过右键菜单调用日志解析弹窗
- 将选中的文本作为参数传递给解析弹窗

### 技术方案
- 扩展MonacoEditor组件，添加获取选中文本的方法
- 在LogPoolView中添加右键菜单事件处理
- 集成openLogPasteDialog工具函数
- 添加用户友好的确认对话框

### 实现细节
- MonacoEditor组件新增getSelectedText()方法
- 添加defineExpose暴露方法给父组件
- 使用Monaco编辑器内置的右键菜单系统
- 自定义右键菜单动作，添加"解析选中日志"选项
- 实现文本选择验证和直接解析流程

### 功能特性
- 支持在Monaco编辑器中选中文本
- 使用Monaco编辑器内置右键菜单系统
- 自定义右键菜单动作，包含"解析选中日志"和"复制选中内容"
- 自动获取选中文本并传递给解析弹窗
- 提供键盘快捷键支持（Ctrl+C复制）
- 添加使用说明到界面中

### 用户体验
- 选中文本后右键菜单直接显示"解析选中日志"选项
- 使用Monaco编辑器原生的右键菜单体验
- 支持键盘快捷键操作
- 无选中文本时菜单项自动禁用
- 集成到现有的使用说明中

### 影响范围
- 修改组件：MonacoEditor.vue（添加选中文本功能）
- 修改组件：LogPoolView.vue（集成右键菜单功能）
- 更新使用说明文档

### 文件修改
- `frontend/src/components/common/MonacoEditor.vue`
  - 添加getSelectedText()方法
  - 添加defineExpose暴露方法
  - 自定义Monaco编辑器右键菜单动作
  - 添加"解析选中日志"和"复制选中内容"菜单项
  - 支持键盘快捷键（Ctrl+C）

- `frontend/src/views/LogPoolView.vue`
  - 添加monacoEditorRef引用
  - 导入openLogPasteDialog工具
  - 实现handleParseLog事件处理
  - 简化右键菜单处理逻辑
  - 更新使用说明文档

---

## JSON解析正则表达式优化

### 功能需求
用户要求将JSON解析的正则表达式改为贪心的，以支持嵌套的JSON对象结构。

### 技术方案
将客户端日志语言定义中的JSON匹配规则从非贪心改为贪心匹配，支持嵌套的JSON对象结构。

### 主要改进

#### 1. 正则表达式优化
- **修改前**: `/\{[^}]*\}/` - 非贪心匹配，只匹配到第一个 `}`
- **修改后**: `/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/` - 贪心匹配，支持嵌套结构

#### 2. 技术实现
```typescript
// 修改前（简单匹配）
[/\{[^}]*\}/, 'json'],

// 修改后（贪心匹配，支持嵌套）
[/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/, 'json'],
```

### 技术优势
- **嵌套支持**: 能够正确高亮嵌套的JSON对象
- **准确性提升**: 避免错误地截断JSON结构
- **向后兼容**: 保持对简单JSON对象的支持
- **性能优化**: 正则表达式仍然高效

### 影响范围
- 客户端日志语言的高亮显示效果
- JSON对象的语法高亮准确性
- 嵌套JSON结构的正确识别

### 文件修改
- `frontend/src/utils/clientLogLanguage.ts`: 优化JSON解析正则表达式 