# 2025-08-15 更新日志

## PyInstaller 依赖优化

### 优化内容
- 清理了 `build_flask.spec` 文件中的多余依赖项
- 删除了未使用的第三方库依赖
- 移除了标准库模块的显式声明（PyInstaller 会自动包含）

### 删除的依赖项
- **未使用的第三方库**：
  - `git` - 未在代码中使用
  - `lxml` 相关模块 - 未使用XML处理功能
  - `sqlite3` - 未使用数据库功能
  - `charset_normalizer` - 未使用字符编码检测
  - `dateutil`, `pytz` - 未使用高级日期处理
  - `six` - 未使用兼容性库
  - `tomli` - 未使用TOML解析
  - `wheel`, `setuptools` - 未使用包管理功能
  - `importlib_metadata` - 未使用元数据功能
  - `zipp` - 未使用压缩功能
  - `jaraco.*` 系列 - 未使用相关工具库
  - `more_itertools` - 未使用迭代工具
  - `backports.tarfile` - 未使用tar文件处理

- **标准库模块**（PyInstaller 自动包含）：
  - `pathlib`, `json`, `hashlib`, `zipfile`, `shutil`
  - `datetime`, `subprocess`, `typing`, `os`, `sys`
  - `mimetypes`, `functools`, `traceback`, `re`, `codecs`

### 预期效果
- 减少构建后的可执行文件体积
- 加快构建速度
- 减少不必要的依赖冲突风险
- 保持应用功能完整性

### 技术说明
PyInstaller 会自动检测和包含标准库模块，无需在 `hiddenimports` 中显式声明。只有第三方库和特殊的导入情况才需要手动指定。

## Docker 多阶段构建架构改进

### 改进内容
- 重构了 `Dockerfile.prod`，采用多阶段构建架构
- Flask 程序使用预构建的 Python Windows 镜像进行构建
- 前端程序使用 Node.js 镜像进行预构建
- 最终运行镜像只包含必要的运行时文件

### 构建阶段说明

#### 第一阶段：Flask 程序构建
- 使用 `mcr.microsoft.com/windows/python:3.11` 镜像（预构建的Python环境）
- 直接安装项目依赖和 PyInstaller
- 使用 PyInstaller 构建可执行文件
- 输出到 `static/updates` 目录

#### 第二阶段：前端程序构建
- 使用 `node:18-alpine` 镜像
- 安装 npm 依赖并执行 `npm run build`
- 构建产物输出到 `dist` 目录

#### 第三阶段：最终运行镜像
- 基于 `hub-dev.hexin.cn:9544/business-baseimage-python/python:v3.11.12`
- 从构建阶段复制预构建的文件
- 只安装运行时必要的 Python 依赖

### 新增文件
- `scripts/build_flask_for_electron.bat` - Windows 版本 Flask 构建脚本
- `.dockerignore` - Docker 构建优化配置

### 优势
- **构建环境一致性**：Flask 程序在 Windows 环境下构建，确保兼容性
- **预构建环境**：使用官方 Python Windows 镜像，避免手动安装 Python
- **依赖分离**：构建依赖和运行依赖分离，减少最终镜像大小
- **构建速度**：多阶段并行构建，提高整体构建效率
- **维护性**：清晰的构建流程，便于调试和维护
- **部署优化**：最终镜像只包含运行时必要文件

### 使用方法
```bash
# 构建生产环境镜像
docker build -f Dockerfile.prod -t log-analyzer:prod .

# 运行容器
docker run -p 5000:5000 log-analyzer:prod
```
