# 2025-08-14 更新日志

## 功能改进

### Flask版本检查接口化
- 修改 `client/main.js` 中的 `getAvailableVersion()` 方法
- 将本地文件版本检查改为通过 `/api/updates/flask/version` 接口获取
- 移除本地文件回退机制，完全依赖接口获取版本信息
- 提高版本检查的实时性和准确性

### Flask应用下载接口化
- 重构 `downloadFlaskApp()` 方法，通过 `/api/updates/flask/download` 接口下载应用
- 移除对本地 `flask-version.json` 文件的依赖
- 实现流式下载，提高下载效率和稳定性

### 本地版本文件自主管理
- 实现本地版本文件的自主创建和更新
- 首次下载时自动创建版本文件，记录版本信息和下载时间
- 更新后自动更新本地版本文件，记录更新时间和来源
- 版本文件包含：版本号、时间戳、来源标识等信息

### Flask应用目录路径优化
- 将Flask应用目录从用户数据目录改为Electron打包后的 `\resources\flask` 目录
- 确保打包后的应用能够正确找到Flask应用
- 版本文件路径同步更新为 `flask-version.json`

### 构建脚本版本信息自动化
- 修改 `scripts/build_flask_for_electron.bat` 脚本
- 构建时自动从根目录 `VERSION` 文件读取版本号
- 自动生成包含版本号、文件大小、构建日期、校验和的 `flask-version.json` 文件
- 新增Linux/Unix版本的构建脚本 `scripts/build_flask_for_electron.sh`

## 技术细节

### 接口信息
- 版本检查接口：`GET /api/updates/flask/version`
- 应用下载接口：`GET /api/updates/flask/download`
- 响应格式：版本信息为JSON，应用文件为二进制流
- 本地版本文件：`flask-version.json`（自主管理）

### 版本文件结构
```json
{
  "version": "1.0.0",
  "download_time": "2025-08-14T10:30:00.000Z",
  "source": "api"
}
```

### 构建脚本改进
- Windows批处理脚本：自动从 `VERSION` 文件读取版本号
- Linux/Unix脚本：支持跨平台构建
- 自动生成完整的版本信息文件
- 包含文件大小、构建日期、MD5校验和等信息

## 修复Flask应用更新时的文件占用错误

### 问题描述
在Windows系统中，当Flask应用正在运行时，尝试更新`flask_app.exe`文件会出现`EBUSY: resource busy or locked`错误，这是因为目标文件正在被使用，无法直接覆盖。

### 解决方案
1. **进程管理优化**：在更新Flask应用之前，先优雅地停止正在运行的Flask进程
2. **安全的文件替换**：使用备份和重命名的方式替换文件，避免直接覆盖正在使用的文件
3. **自动重启**：更新完成后自动重启Flask应用，确保服务连续性

### 技术实现
- 在`downloadFlaskApp()`方法中添加进程停止逻辑
- 使用`SIGTERM`信号优雅停止进程，5秒后强制使用`SIGKILL`
- 实现文件备份机制，更新失败时可回滚
- 添加`restartFlaskApp()`方法处理应用重启
- 更新完成后自动检测并重启Flask应用

### 影响范围
- `client/main.js` - Flask应用管理器
- 修复了Windows环境下Flask应用更新失败的问题
- 提升了应用更新的稳定性和用户体验

### 测试建议
1. 在Flask应用运行时触发更新
2. 验证进程停止和文件替换的稳定性
3. 确认更新后应用能正常重启
4. 测试更新失败时的回滚机制
